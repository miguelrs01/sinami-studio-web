import{a as y,l as n,d as k,b as f,g as m,u as g,T}from"./index-DFKcezkU.js";class p{async trackGameStart(){var e;try{const t=y.currentUser;if(!t){n.warn("[PlayTimeTracking] ‚ö†Ô∏è Usuario no autenticado");return}const a=this.getDeviceId();if(!a){n.warn("[PlayTimeTracking] ‚ö†Ô∏è No se pudo obtener device ID");return}const r=new Date,o=r.getDay(),i=r.getHours();n.info("[PlayTimeTracking] üìä Registrando sesi√≥n de juego:",{dayOfWeek:o,hour:i,timestamp:r.toISOString()});const s=k(f,"consolidated","user_tokens"),l=await m(s);if(!l.exists()){n.warn("[PlayTimeTracking] ‚ö†Ô∏è Documento de tokens no existe");return}const u=(e=l.data().tokens)==null?void 0:e[t.uid],P=u==null?void 0:u[a];if(!P){n.warn("[PlayTimeTracking] ‚ö†Ô∏è Token de dispositivo no encontrado");return}const d=P.playPattern;this.shouldUpdatePattern(d,o,i)?(await g(s,{[`tokens.${t.uid}.${a}.playPattern`]:{dayOfWeek:o,hour:i,lastPlayed:T.now(),lastNotificationSent:(d==null?void 0:d.lastNotificationSent)||null,notificationOpened:!1,detectedAt:T.now()}}),n.info("[PlayTimeTracking] ‚úÖ Patr√≥n actualizado:",{dayOfWeek:o,hour:i})):(await g(s,{[`tokens.${t.uid}.${a}.playPattern.lastPlayed`]:T.now()}),n.info("[PlayTimeTracking] ‚úÖ √öltima sesi√≥n actualizada"))}catch(t){n.error("[PlayTimeTracking] ‚ùå Error registrando sesi√≥n:",t)}}shouldUpdatePattern(e,t,a){return!e||e.dayOfWeek!==t||e.hour!==a}getDeviceId(){try{return localStorage.getItem("device_id")}catch{return null}}async getCurrentPattern(){var e,t,a;try{const r=y.currentUser;if(!r)return null;const o=this.getDeviceId();if(!o)return null;const i=k(f,"consolidated","user_tokens"),s=await m(i);if(!s.exists())return null;const c=(a=(t=(e=s.data().tokens)==null?void 0:e[r.uid])==null?void 0:t[o])==null?void 0:a.playPattern;return c?{dayOfWeek:c.dayOfWeek,hour:c.hour,lastPlayed:c.lastPlayed.toDate()}:null}catch(r){return n.error("[PlayTimeTracking] ‚ùå Error obteniendo patr√≥n:",r),null}}async clearPattern(){try{const e=y.currentUser;if(!e)return;const t=this.getDeviceId();if(!t)return;const a=k(f,"consolidated","user_tokens");await g(a,{[`tokens.${e.uid}.${t}.playPattern`]:null}),n.info("[PlayTimeTracking] ‚úÖ Patr√≥n limpiado")}catch(e){n.error("[PlayTimeTracking] ‚ùå Error limpiando patr√≥n:",e)}}}const v=new p;export{v as playTimeTrackingService};
