import{C as E,r as L,F as N,d as U,b as m,g as w,c as O,e as G,f as T,u as I,s as g,h as C,a as P}from"./index-BGV8uWsu.js";const S=async()=>[],B=async s=>{},A=L("AppleGameCenter");let v=null,F=null,h=!1,p=null;const M=()=>E.getPlatform()!=="ios"?(console.warn("[GameCenter] Solo disponible en iOS"),null):A||(console.error("[GameCenter] Plugin no encontrado"),null),V=async()=>{if(h){console.log("[GameCenter] Ya inicializado");return}return p?(console.log("[GameCenter] Esperando inicializaciÃ³n en curso..."),p):(p=(async()=>{try{console.log("[GameCenter] ðŸš€ Iniciando...");const s=M();if(!s){console.log("[GameCenter] Plugin no disponible (Web/Android), modo anÃ³nimo"),h=!0;return}const e=await s.silentSignIn();e.isAuthenticated&&e.playerId?(v=e.playerId,F=e.displayName||null,console.log("[GameCenter] âœ… Login silencioso exitoso:",{playerId:v,displayName:F})):console.log("[GameCenter] â„¹ï¸ Login silencioso no disponible (usuario no autenticado previamente)"),h=!0}catch(s){console.error("[GameCenter] âŒ Error en inicializaciÃ³n:",s),h=!0}finally{p=null}})(),p)},Z=()=>v,D=()=>O(),x=()=>!!P.currentUser;let i=new Set,y=new Set,f=!1;const q=()=>!P||!P.currentUser?(console.warn("[UserPacks] No hay usuario autenticado en Firebase Auth"),null):P.currentUser.uid,_=async(s=2500)=>{try{if(!P||P.currentUser)return;await new Promise(e=>{let o=!1;const r=P.onAuthStateChanged(()=>{if(!o){o=!0;try{r==null||r()}catch{}e()}});setTimeout(()=>{if(!o){o=!0;try{r==null||r()}catch{}e()}},s)})}catch(e){console.warn("[UserPacks] âš ï¸ waitForAuthReady fallÃ³:",e)}},W=async(s,e)=>{var o,r;try{if(e===s)return;console.log("[UserPacks] ðŸ”„ Verificando migraciÃ³n desde sistema antiguo..."),console.log("[UserPacks] Antiguo userId:",e),console.log("[UserPacks] Nuevo Firebase UID:",s);const l=U(m,"userPacks",e),n=await w(l);if(!n.exists()){console.log("[UserPacks] No hay datos antiguos para migrar");return}const a=U(m,"userPacks",s),c=await w(a);if(c.exists()){console.log("[UserPacks] El documento nuevo ya existe, fusionando datos...");const t=n.data(),u=c.data(),d=Array.from(new Set([...u.packs||[],...t.packs||[]])),k=Array.from(new Set([...u.codes||[],...t.codes||[]])),R=Array.from(new Set([...u.deviceIds||[],...t.deviceIds||[],e]));await I(a,{packs:d,codes:k,deviceIds:R,ts:g()}),console.log("[UserPacks] âœ… Datos fusionados exitosamente"),console.log("[UserPacks] Packs:",d.length,"CÃ³digos:",k.length)}else{console.log("[UserPacks] Copiando datos del documento antiguo al nuevo...");const t=n.data();await C(a,{packs:t.packs||[],codes:t.codes||[],deviceIds:[e],ts:g()}),console.log("[UserPacks] âœ… Datos migrados exitosamente"),console.log("[UserPacks] Packs:",((o=t.packs)==null?void 0:o.length)||0,"CÃ³digos:",((r=t.codes)==null?void 0:r.length)||0)}console.log("[UserPacks] ðŸ“ Documento antiguo preservado para recuperaciÃ³n")}catch(l){console.error("[UserPacks] âŒ Error en migraciÃ³n:",l)}},j=async()=>{var s;try{if(!N)return console.log("[UserPacks] Firebase no habilitado, modo local"),[];await _();const e=async a=>{const c=U(m,"userPacks",a),t=await w(c);if(t.exists()){const u=t.data(),d=u.packs||[],k=u.codes||[];return i=new Set(d),y=new Set(k),f=!0,d}return i.clear(),y.clear(),f=!0,[]};if(!x()){const a=D();return a?(console.log("[UserPacks] Usuario no autenticado, usando fallback deviceId:",a),await e(a)):(console.log("[UserPacks] Usuario no autenticado, sin packs sincronizados"),i.clear(),y.clear(),f=!0,[])}const o=q();if(!o){console.warn("[UserPacks] âš ï¸ No hay Firebase Auth UID, usando fallback...");const a=D();if(!a)return[];console.log("[UserPacks] ðŸ”„ Usando sistema antiguo con userId:",a);const c=await e(a);return console.log("[UserPacks] âœ… Packs sincronizados (sistema antiguo):",c),c}const r=D();if(console.log("[UserPacks] Firebase UID:",o),console.log("[UserPacks] Old User ID:",r),r&&r!==o){if(await W(o,r),await G(r,o),E.getPlatform()==="ios")try{await V();const a=Z();a&&(console.log("[UserPacks] ðŸ Vinculando Game Center ID:",a),await G(a,o))}catch(a){console.warn("[UserPacks] âš ï¸ Error vinculando Game Center:",a)}await T(o,r)}const l=U(m,"userPacks",o),n=await w(l);if(n.exists()){const a=n.data(),c=a.packs||[],t=a.codes||[];i=new Set(c),y=new Set(t),f=!0,console.log("[UserPacks] âœ… Packs sincronizados:",c),console.log("[UserPacks] ðŸ“Š CÃ³digos usados:",t.length),console.log("[UserPacks] ðŸ“± Dispositivos vinculados:",((s=a.deviceIds)==null?void 0:s.length)||0),console.log("[UserPacks] ðŸ’° OPTIMIZACIÃ“N: 1 lectura para todos los datos");const u=await S(),d=Array.from(new Set([...c||[],...u]));if(d.length>c.length){try{await I(l,{packs:d,ts:g()}),console.log("[UserPacks] ðŸ”„ Firestore actualizado con packs desde GPGS:",d.length)}catch(k){console.warn("[UserPacks] âš ï¸ No se pudo persistir merge en Firestore:",k)}i=new Set(d)}return Array.from(i)}else{console.log("[UserPacks] Usuario nuevo, sin packs adquiridos"),i.clear(),y.clear(),f=!0;const a=await S();if(a.length>0)try{return await C(l,{packs:a,codes:[],deviceIds:r?[r]:[],ts:g()}),i=new Set(a),console.log("[UserPacks] ðŸŒ± Seed de packs desde GPGS en Firestore:",a.length),a}catch(c){console.warn("[UserPacks] âš ï¸ Error haciendo seed desde GPGS:",c)}return[]}}catch(e){return console.error("[UserPacks] âŒ Error sincronizando packs:",e),[]}},z=s=>f?i.has(s):(console.warn("[UserPacks] CachÃ© no cargado, llamar a syncUserPacks() primero"),!1),H=async s=>{try{if(!N)return{success:!1,error:"Firebase no habilitado"};const e=D();if(!x())return e?(console.log("[UserPacks] âš ï¸ Usuario no autenticado, usando sistema antiguo para acquireFreePack"),await b(s,e)):{success:!1,error:"No hay ID de usuario disponible"};const o=q();if(!o)return e?(console.log("[UserPacks] âš ï¸ Usando sistema antiguo para acquireFreePack"),await b(s,e)):{success:!1,error:"No hay ID de usuario disponible"};if(z(s))return console.log("[UserPacks] Pack ya adquirido:",s),{success:!0};console.log("[UserPacks] ðŸ’° Adquiriendo pack gratuito:",s);const r=U(m,"userPacks",o),l=await w(r);if(l.exists()){const n=l.data(),a=n.packs||[],c=n.deviceIds||[];a.includes(s)||await I(r,{packs:[...a,s],deviceIds:e&&!c.includes(e)?[...c,e]:c,ts:g()})}else await C(r,{packs:[s],codes:[],deviceIds:e?[e]:[],ts:g()});i.add(s),console.log("[UserPacks] âœ… Pack adquirido exitosamente"),console.log("[UserPacks] ðŸ’° OPTIMIZACIÃ“N: 1 escritura en Firestore");try{await B(Array.from(i)),console.log("[UserPacks] ðŸ§© GPGS actualizado post-adquisiciÃ³n gratuita")}catch(n){console.warn("[UserPacks] âš ï¸ No se pudieron guardar packs en GPGS:",n)}return{success:!0}}catch(e){return console.error("[UserPacks] âŒ Error adquiriendo pack gratuito:",e),{success:!1,error:"Error al guardar en Firestore"}}},b=async(s,e)=>{try{if(z(s))return{success:!0};const o=U(m,"userPacks",e),r=await w(o);if(r.exists()){const n=r.data().packs||[];n.includes(s)||await I(o,{packs:[...n,s],ts:g()})}else await C(o,{packs:[s],codes:[],ts:g()});return i.add(s),{success:!0}}catch(o){return console.error("[UserPacks] Error en acquireFreePackLegacy:",o),{success:!1,error:"Error al guardar"}}};export{H as acquireFreePack,z as hasUserPack,j as syncUserPacks};
